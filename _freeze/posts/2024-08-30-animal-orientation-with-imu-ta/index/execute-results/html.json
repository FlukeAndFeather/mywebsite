{
  "hash": "e85da09965d82e6c1023c1e1b9c6b34c",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: Animal orientation with IMU tags\ndescription: Derivations of formulas for estimating pitch, roll, and heading of an animal from a tag with an accelerometer and magnetometer.\nauthor:\n  - name: Max Czapanskiy\nformat: html\ndate: 2024-08-30\ncategories: [biologging]\nbibliography: references.bib\n---\n\n\n\nEvery 6-18 months, my friend Jessie and I try to remember the linear algebra required to estimate animal orientation (pitch, roll, heading) from an accelerometer/magnetometer tag. This usually involves a 2-3 hour Zoom call, frantic whiteboard activity, and moderate hair loss. In the hopes of breaking this stressful cycle, here are my notes about the subject.\n\n::: callout-note\nThis post is my version of Mark Johnson's notes from the 2011 fine-scale animal movement workshop in Hobart, Australia. The bulk of the material is his. My changes include different axis conventions, expanded derivations where I found myself lost, and removal of some material about hardware.\n:::\n\n## Reference frames\n\nA major source of confusion is often the reference frame. We're going to describe orientation as a rotation. The reference frame describes what it's a rotation *from*. A pitch of 45° means something intuitively (facing halfway from the horizon to straight up), but mathematically it only has meaning if we specify what we're pitching 45° relative to. Enter reference frames.\n\nWe use three reference frames, which we call $\\Psi$. One for the world at large (AKA navigation, $\\Psi^n$), one for the animal's body ($\\Psi^a$), and a third for the tag ($\\Psi^t$).\n\n$$\n\\begin{align}\n\\Psi^n &= \\begin{bmatrix}\nN ~ E ~ D\n\\end{bmatrix} \\\\\n\\Psi^a &= \\begin{bmatrix}\nX^a ~ Y^a ~ Z^a\n\\end{bmatrix} \\\\\n\\Psi^t &= \\begin{bmatrix}\nX^t ~ Y^t ~ Z^t\n\\end{bmatrix}\n\\end{align}\n$$\n\nWhere $N$, $E$, and $D$ represent the vectors for north, east, and down, respectively. $X^a$ is the longitudinal axis of the animal (along the spine), $Y^a$ is the transverse axis (left to right), and $Z^a$ is the dorso-ventral axis. Same for $X^t$, $Y^t$, $Z^t$, but for the tag instead of the animal.\n\nBecause the vectors $N$, $X^a$, etc are 3x1, these reference frames are all 3x3 matrices. When we align with their point of view, we define them to be the identity matrix, $I$.\n\n::: callout-note\n$\\Psi^n$ is controversial within the animal tagging community. A conventional right-hand rule reference frame would be $\\begin{bmatrix} N ~ W ~ U \\end{bmatrix}$, not $\\begin{bmatrix} N ~ E ~ D \\end{bmatrix}$. Hold your hand out and stick out your thumb and first two fingers all at right angles (pointer forward, thumb up, middle finger left). Let your pointer be $N$, your middle finger be $W$, and your thumb be $U$. Notice how comfortable that is? Unfortunately, the math makes it such that *positive pitch means down* in this orientation. Most people find that counter-intuitive. We have two options to change that: adopt a left-hand rule system $\\begin{bmatrix} N ~ E ~ U \\end{bmatrix}$ or an \"upside down\" right-hand rule $\\begin{bmatrix} N ~ E ~ D \\end{bmatrix}$. Within the marine vertebrate research community, there's a split. Some use the left-hand rule $\\begin{bmatrix} N ~ E ~ U \\end{bmatrix}$ [@Johnson2003] and others the upside-down right-hand rule $\\begin{bmatrix} N ~ E ~ D \\end{bmatrix}$ [@Cade2021]. I find keeping the right-hand rule makes more sense to me personally, so that's what I'll use here.\n:::\n\n## Rotation matrices\n\nRotations are defined using Euler angles: the familiar pitch, roll, and heading. We define two important rotation matrices: $\\boldsymbol{Q}$ and $\\boldsymbol{W}$.\n\n$\\boldsymbol{Q}$ is the rotation matrix describing the orientation of the animal frame relative to the navigation frame.\n\n$$\n\\Psi^a = \\Psi^n \\boldsymbol{Q}\n$$\n\nThat's often tricky to understand, so I'll repeat it. Our estimate of the animal's body orientation is a rotation matrix. $\\boldsymbol{Q}$ itself is the product of three other rotation matrices, which define the pitch, roll, and heading of the animal. Therefore, $\\boldsymbol{Q}$ is a biologically meaningful variable that we're interested in studying.\n\n$\\boldsymbol{W}$ is the rotation matrix describing the animal's orientation relative to the tag.\n\n$$\n\\Psi^a = \\Psi^t \\boldsymbol{W}\n$$\n\nLike $\\boldsymbol{Q}$, $\\boldsymbol{W}$ is the product of three rotations, which yaw, pitch, and roll the tag relative to the animal. Unlike $\\boldsymbol{Q}$, $\\boldsymbol{W}$ is not biologically meaningful. However, we need $\\boldsymbol{W}$ to figure out $\\boldsymbol{Q}$ because we can't measure $\\boldsymbol{Q}$ directly.\n\nWhat does a rotation matrix actually look like? There are three we use often, which are the rotations around the reference frame axes themselves. Hold out your hand in $\\begin{bmatrix} N ~ E ~ D \\end{bmatrix}$ orientation. Rotate forward to pitch your pointer down. Which axis did you rotate *around*? Your thumb is pointing in a new direction, too, but your middle finger (which represents $E$, the y-axis) is still pointing to the right. So we see *pitch is a* *rotation around the y-axis*. The same is also true for roll (around the x-axis) and yaw (around the z-axis). Mathematically, they look like this:\n\n$$\n\\begin{align}\nY(\\gamma) &= \\begin{bmatrix}\ncos ~ \\gamma & -sin ~ \\gamma & 0 \\\\\nsin ~ \\gamma & cos ~ \\gamma & 0 \\\\\n0 & 0 & 1\n\\end{bmatrix} \\\\\nP(p) &= \\begin{bmatrix}\ncos ~ p & 0 & sin ~ p \\\\\n0 & 1 & 0 \\\\\n-sin ~ p & 0 & cos ~ p\n\\end{bmatrix} \\\\\nR(r) &= \\begin{bmatrix}\n1 & 0 & 0 \\\\\n0 & cos ~ r & -sin ~ r \\\\\n0 & sin ~ r & cos ~ r\n\\end{bmatrix}\n\\end{align}\n$$\n\nWhere $Y$, $P$, and $R$ are the yaw, pitch, and roll matrices, respectively. $\\gamma$, $p$, and $r$ are the yaw, pitch, and roll angles themselves. They're not symmetrical matrices, which means matrix multiplication won't be commutative, so order matters. We always apply them in the order $YPR$. This has the effect of rotating around the local axes, those of the thing itself being rotated. The reverse order, $RPY$ applies the rotations relative to the global axes. If that doesn't makes sense don't worry about it, just remember for $Q$ and $W$ we always rotate in the order $YPR$.\n\n## Accelerometers, gravity, pitch, and roll\n\n### What do accelerometers measure?\n\nAccelerometers measure acceleration. Acceleration can mean a few different things, and the particular kind of acceleration measured by accelerometers is not the intuitive one for most of us.\n\nImagine a tag at rest on a table. Is it accelerating? Instinctively, we think of acceleration *relative to a coordinate system*. And since the tag's position isn't changing, we would say it isn't accelerating. However, an accelerometer would measure an acceleration of 9.8 m s^-2^ straight down. Similarly, if we went to the top of a tower and dropped a tag, we would observe it accelerating at 9.8 m s^-2^ straight down, but the accelerometer would read 0.\n\nThese counter-intuitive readings are because accelerometers measure *proper acceleration*, which is relative to the inertial frame of reference. We don't need to dive into the precise physics of inertial reference frames. In short, here's the intuition that will help: the accelerometer readings are relative to an object in free fall.\n\n### Estimating pitch and roll\n\nWe can use the accelerometer readings to detect the pitch and roll of an object at rest. At rest, the only force is gravity, which is aligned downwards, along $D$. So the acceleration measured by the tag is:\n\n$$\nA^t = g D^T \\Psi^t\n$$\n\nWhere $A^t$ is the 1x3 vector of accelerometer readings $\\begin{bmatrix} a_x ~ a_y ~ a_z \\end{bmatrix}$. $g$ is the strength of gravitational acceleration (about 9.8 m s^-2^). Notice the T in $D^T$ is capitalized. We use lower case $t$ to indicate something to do with the tag e.g., $\\Psi^t$. Capital T here means we're transposing the column vector representing \"down\" into a row vector. That just makes the math easier.\n\nWe have a problem here, though. $A^t$ is measured in the tag's reference frame (hence the $\\Psi^t$), but down $D^T$ is defined in the navigation frame. Let's pretend for a second the tag frame is aligned with the animal frame (i.e., $\\Psi^a = \\Psi^t$) . Then, recall our reference frame definition $\\Psi^a = \\Psi^n Q$. Substituting that in, we get:\n\n$$\n\\begin{align}\nA^t &= g D^T \\Psi^t \\\\\nA^t &= g D^T \\Psi^n Q \\\\\nA^t &= g \\begin{bmatrix} 0 ~ 0 ~ 1 \\end{bmatrix}Q\n\\end{align}\n$$That works because, by definition, $D^T \\Psi^n = \\begin{bmatrix}0 ~ 0 ~ 1\\end{bmatrix}$. That's how we defined \"down\" in the navigational reference frame.\n\nNow recall the rotation matrices for yaw, pitch, and roll, and that $Q$ is the composition of those three. When we substitute in $Y$, $D$ will just cancel it out. This should make sense intuitively: gravity's effect on your acceleration is the same whether you face north, south, east, or west. Then we can solve for $A^t$ based on $P$ and $R$.\n\n$$\n\\begin{align}\nA^t &= g \\begin{bmatrix} 0 ~ 0 ~ 1 \\end{bmatrix} Q \\\\\nA^t &= g \\begin{bmatrix} 0 ~ 0 ~ 1 \\end{bmatrix} Y(\\gamma) P(p) R(r) \\\\\nA^t &= g \\begin{bmatrix} 0 ~ 0 ~ 1 \\end{bmatrix} \\begin{bmatrix}\ncos ~ \\gamma & -sin ~ \\gamma & 0 \\\\\nsin ~ \\gamma & cos ~ \\gamma & 0 \\\\\n0 & 0 & 1\n\\end{bmatrix} P(p) R(r) \\\\\nA^t &= g \\begin{bmatrix} 0 ~ 0 ~ 1 \\end{bmatrix} P(p) R(r) \\\\\nA^t &= g \\begin{bmatrix} 0 ~ 0 ~ 1 \\end{bmatrix} \\begin{bmatrix}\ncos ~ p & 0 & sin ~ p \\\\\n0 & 1 & 0 \\\\\n-sin ~ p & 0 & cos ~ p\n\\end{bmatrix} \\begin{bmatrix}\n1 & 0 & 0 \\\\\n0 & cos ~ r & -sin ~ r \\\\\n0 & sin ~ r & cos ~ r\n\\end{bmatrix} \\\\\nA^t &= g \\begin{bmatrix} -sin~p & 0 & cos~p \\end{bmatrix} \\begin{bmatrix}\n1 & 0 & 0 \\\\\n0 & cos ~ r & -sin ~ r \\\\\n0 & sin ~ r & cos ~ r\n\\end{bmatrix} \\\\\nA^t &= g \\begin{bmatrix} -sin~p & -cos~p~sin~r & -cos~p~cos~r \\end{bmatrix}  \\\\\n\\end{align}\n$$\n\nNow we can solve for $p$ and $r$, our pitch and roll. We'll call them $\\hat{p}$ and $\\hat{r}$ to indicate they're estimates. First, $p$:\n\n$$\n\\begin{align}\na_x &= -g ~ sin ~ \\hat{p} \\\\\nsin ~ \\hat{p} &= \\frac{a_x}{-g} \\\\\n\\hat{p} &= -sin^{-1} \\frac{a_x}{g}\n\\end{align}\n$$\n\nNote: remember $sin ~ {-x} = -sin ~ x$. The formula for $\\hat{p}$ is correct for an object at rest, but usually we're tracking a moving animal. We can improve our estimate if we divide by the norm of the whole acceleration vector, rather than dividing by g. So in practice, $\\hat{p}$ will be:\n\n$$\n\\hat{p} = -sin^{-1} \\frac{a_x}{||A^t||}\n$$\n\nRoll is a bit trickier, but still doable. Start by dividing $a_y$ by $a_z$.\n\n$$\n\\begin{align}\n\\frac{a_y}{a_z} &= \\frac{-cos~\\hat{p}~sin~\\hat{r}}{-cos~\\hat{p}~cos~\\hat{r}} \\\\\n\\frac{a_y}{a_z} &= \\frac{sin~\\hat{r}}{cos~\\hat{r}} \\\\\n\\frac{a_y}{a_z} &= tan~\\hat{r} \\\\\n\\hat{r} &= tan^{-1}~\\frac{a_y}{a_z} \\\\\n\\end{align}\n$$\n\n## Magnetometers, Earth's magnetic field, and heading\n\n### What do magnetometers measure?\n\nFrom accelerometers we can estimate pitch and roll, but we need an alternative to estimate heading. The Earth's magnetic field, roughly speaking, points up at the magnetic south pole, is parallel to the earth's surface around the equator, and points down at the magnetic north pole. So unlike gravity, which always points down at the same strength, the magnetic field vector changes depending on where you are[^1]. We usually call the magnetic field $B$ and it's defined by three parameters: $b$ (the strength of the field), $i$ (inclination of the field, or the angle it's pointing below the horizon), and $d$ (declination of the field, or the angle of magnetic north east of true north). Using rotation matrices, $B$ is:\n\n[^1]: The Earth's gravitational field isn't *exactly* uniform, but it's close enough for our purposes.\n\n$$\n\\begin{align}\nB &= b N^T \\Psi^n P(-i) Y(d)\n\\end{align}\n$$\n\n$b N^T \\Psi^n$ means a vector with magnitude $b$ pointing north in the navigational frame. Then we incline the field by pitching it $i$ below the horizon and yaw it $d$ degrees east. $-i$ because in our navigational reference frame negative pitch means down, remember? Also, this is the only time $P$ will be applied before $Y$. That's because these are global rotations, not local. You'll never do this with tag or animal rotations; those are local rotations[^2]. Solving for $B$, we get:\n\n[^2]: Linear algebra is frickin' weird, I know, I'm so sorry\n\n$$\n\\begin{align}\nB &= b N^T \\Psi^n P(-i) Y(d) \\\\\nB &= b N^T \\Psi^n \n\\begin{bmatrix}\ncos ~ {-i} & 0 & sin ~ {-i} \\\\\n0 & 1 & 0 \\\\\n-sin ~ {-i} & 0 & cos ~ {-i}\n\\end{bmatrix} \n\\begin{bmatrix}\ncos ~ d & -sin ~ d & 0 \\\\\nsin ~ d & cos ~ d & 0 \\\\\n0 & 0 & 1\n\\end{bmatrix} \\\\\nB &= b N^T \\Psi^n \n\\begin{bmatrix}\ncos ~ i & 0 & -sin ~ i \\\\\n0 & 1 & 0 \\\\\nsin ~ i & 0 & cos ~ i\n\\end{bmatrix} \n\\begin{bmatrix}\ncos ~ d & -sin ~ d & 0 \\\\\nsin ~ d & cos ~ d & 0 \\\\\n0 & 0 & 1\n\\end{bmatrix} \\\\\nB &= b \\begin{bmatrix} 1 & 0 & 0 \\end{bmatrix} \n\\begin{bmatrix}\ncos ~ i & 0 & -sin ~ i \\\\\n0 & 1 & 0 \\\\\nsin ~ i & 0 & cos ~ i\n\\end{bmatrix} \n\\begin{bmatrix}\ncos ~ d & -sin ~ d & 0 \\\\\nsin ~ d & cos ~ d & 0 \\\\\n0 & 0 & 1\n\\end{bmatrix} \\\\\nB &= b \\begin{bmatrix} cos ~ i & 0 & -sin ~ i \\end{bmatrix} \n\\begin{bmatrix}\ncos ~ d & -sin ~ d & 0 \\\\\nsin ~ d & cos ~ d & 0 \\\\\n0 & 0 & 1\n\\end{bmatrix} \\\\\nB &= b \\begin{bmatrix} cos~i ~ cos~d & -cos~i ~ sin~d & -sin ~ i \\end{bmatrix} \\\\\n\\end{align}\n$$\n\nA little more complicated than just $\\begin{bmatrix} 0 & 0 & g \\end{bmatrix}$, isn't it? But it's essential for figuring out our heading.\n\n### Estimating heading\n\nWhen you use a compass to find north, it's important to lay it flat. You may have seen compasses where the needle floats in a bubble, which keeps it level despite minor pitches and rolls. That's called *gimbaling* the compass. We need to do the same for our 3d magnetometer readings. Unlike a hand-held compass, we can't do that mechanically. Instead we use $\\hat{p}$ and $\\hat{r}$, which we got from the accelerometer, to rotate the the magnetometer readings to the horizontal. If $M^a$ is the magnetometer reading on the animal, we'll call the gimbaled version $M^h$, where $h$ means horizontal.\n\n$$\n\\begin{align}\nM^h &= M^a (P(\\hat{p}) R(\\hat{r}))^{-1} \\\\\nM^h &= M^a R(\\hat{r})^{-1} P(\\hat{p})^{-1} \\\\\nM^h &= M^a R(\\hat{r})^T P(\\hat{p})^T \\\\\n\\end{align}\n$$\n\nIn matrix multiplication, we get the inverse of a product $(AB)^{-1}$ by reversing and inverting the matrices $B^{-1}A^{-1}$. That's why roll and pitch get flipped around. And rotation matrices have the convenient property where their inverse is their transpose.\n\nNow that we've removed the pitch and roll of the magnetometer to get $M^h$, the magnetic field is only a function of the animal's heading, which we estimate as $\\hat{h}$.\n\n$$\n\\begin{align}\nM^h &= B Y(\\hat{h}) \\\\\nM^h &= b \\begin{bmatrix} cos~i ~ cos~d & -cos~i ~ sin~d & -sin ~ i \\end{bmatrix} \\begin{bmatrix}\ncos ~ \\hat{h} & -sin ~ \\hat{h} & 0 \\\\\nsin ~ \\hat{h} & cos ~ \\hat{h} & 0 \\\\\n0 & 0 & 1\n\\end{bmatrix} \\\\\nM^h &= b\\begin{bmatrix}\ncos~i ~ cos~d ~ cos~\\hat{h} - cos~i ~ sin~d ~ sin~\\hat{h} & \n-cos~i ~ cos~d ~ sin~\\hat{h} - cos~i ~ sin~d ~ cos~\\hat{h} &\n-sin~i\n\\end{bmatrix} \\\\\nM^h &= b\\begin{bmatrix}\ncos~i (cos~d ~ cos~\\hat{h} - sin~d ~ sin~\\hat{h}) & \ncos~i (cos~d ~ sin~\\hat{h} + sin~d ~ cos~\\hat{h}) &\n-sin~i\n\\end{bmatrix} \\\\\n\\end{align}\n$$\n\nNow divide $M^h_x$ by $M^h_y$.\n\n::: callout-tip\nThe following requires the trigonometric identities for differences of angles, which you might not know off the top of your head. They are:\n\n$$\n\\begin{align}\nsin(\\alpha - \\beta) &= sin~\\alpha ~ cos~\\beta - cos~\\alpha ~ sin~\\beta \\\\\ncos(\\alpha - \\beta) &= cos~\\alpha ~ cos~\\beta - sin~\\alpha ~ sin~\\beta\n\\end{align}\n$$\n:::\n\n$$\n\\begin{align}\n\\frac{M^h_y}{M^h_x} &= \\frac{cos~i (sin~\\hat{h} ~ cos~d - cos~\\hat{h} ~ sin~d)}{cos~i (cos~d ~ cos~\\hat{h} + sin~d ~ sin~\\hat{h})} \\\\\n\\frac{M^h_y}{M^h_x} &= \\frac{sin~\\hat{h} ~ cos~d - cos~\\hat{h} ~ sin~d}{cos~d ~ cos~\\hat{h} - sin~d ~ sin~\\hat{h}} \\\\\n\\frac{M^h_y}{M^h_x} &= \\frac{sin(\\hat{h} - d)}{cos(\\hat{h} - d)} \\\\\n\\frac{M^h_y}{M^h_x} &= tan(\\hat{h} - d) \\\\\n\\hat{h} - d &= tan^{-1}(\\frac{M^h_y}{M^h_x}) \\\\\n\\hat{h} &= tan^{-1}(\\frac{M^h_y}{M^h_x}) + d \\\\\n\\end{align}\n$$\n\n::: callout-note\nThis is different than Mark Johnson's result and I haven't figure out why yet. I may have defined $B$ differently, perhaps? But this way makes more sense to me because I can see how it uses declination to correct for the difference between magnetic and true north. I need to ask someone about this!\n:::\n\n## What about $W$?\n\nUp to this point we have operated under the assumption the tag and animal reference frames were aligned. That's often not the case, and figuring out $W$ can be tricky! If the tag is attached to an animal in hand, as is often the case for seabirds and pinnipeds, then $W$ may be very close to $I$. However, if the tag is attached to an animal in motion, which is common in cetacean studies, $W$ could be just about anything. The full suite of methods for estimating $W$ from tag data itself is outside the scope of this blog post, but I will show how to derive $W$ on two conditions. 1) There's a period of time when the animal's orientation is known (i.e., we know $Q$) and 2) the yaw of the tag with respect to the animal is 0. These conditions are typically met in the animal-in-hand scenario, where the tag is manually attached along the longitudinal axis of the animal, but the curvature of the animal's body may pitch or roll the tag away from $I$.\n\nLet $\\bar{A}_t$ be the mean acceleration reading during the period of known animal orientation. Let's also say that during this time, the animal's pitch and roll relative to the navigational frame are 0 (i.e., it's laying flat). Define the pitch and roll of the tag relative to the animal as $p_0$ and $r_0$, respectively. Notice $p_0$ and $r_0$ are the orientation of the *tag* relative to the *animal*, so they define $W^{-1}$, not $W$. Then:\n\n$$\n\\begin{align}\n\\bar{A}_t &= g D^T Q W^{-1} \\\\ \nQ &= Y(\\gamma)P(0)R(0) \\\\ \nW^{-1} &= Y(0)P(p_0)R(r_0) \\\\ \n\\bar{A}_t &= g \\begin{bmatrix}0 & 0 & 1\\end{bmatrix} Y(\\gamma)P(0)R(0) Y(0)P(p_0)R(r_0) \\\\\n\\bar{A}_t &= g \\begin{bmatrix}0 & 0 & 1\\end{bmatrix} P(p_0)R(r_0) \\\\\n\\bar{A}_t &= g \\begin{bmatrix}0 & 0 & 1\\end{bmatrix} \n\\begin{bmatrix}\ncos ~ p_0 & 0 & sin ~ p_0 \\\\\n0 & 1 & 0 \\\\\n-sin ~ p_0 & 0 & cos ~ p_0\n\\end{bmatrix}\n\\begin{bmatrix}\n1 & 0 & 0 \\\\\n0 & cos ~ r_0 & -sin ~ r_0 \\\\\n0 & sin ~ r_0 & cos ~ r_0\n\\end{bmatrix} \\\\\n\\bar{A}_t &= g \\begin{bmatrix}-sin ~ p_0 & 0 & cos ~ p_0\\end{bmatrix}  \n\\begin{bmatrix}\n1 & 0 & 0 \\\\\n0 & cos ~ r_0 & -sin ~ r_0 \\\\\n0 & sin ~ r_0 & cos ~ r_0\n\\end{bmatrix} \\\\\n\\bar{A}_t &= g \\begin{bmatrix}\n-sin~p_0 & cos~p_0~sin~r_0 & cos~p_0~cos~r_0\n\\end{bmatrix}\n\\end{align}\n$$\n\nNow we can get $p_0$ from $\\bar{A}_{tx}$ and $r_0$ from the ratio of $\\bar{A}_{ty}$ and $\\bar{A}_{tz}$.\n\n$$\n\\begin{align}\n\\bar{A}_{tx} &= -g~sin~p_0 \\\\\np_0 &= -sin^{-1}\\frac{\\bar{A}_{tx}}{g}\n\\end{align}\n$$\n\nUsing the same correction as before, we actually use $p_0 = -sin^{-1}\\frac{\\bar{A}_{tx}}{||\\bar{A}_t||}$.\n\n$$\n\\begin{align}\n\\frac{\\bar{A}_{ty}}{\\bar{A}_{tz}} &= \\frac{cos~p_0 ~ sin~r_0}{cos~p_0 ~ cos~r_0} \\\\\n\\frac{\\bar{A}_{ty}}{\\bar{A}_{tz}} &= \\frac{sin~r_0}{cos~r_0} \\\\\n\\frac{\\bar{A}_{ty}}{\\bar{A}_{tz}} &= tan(r_0) \\\\\nr_0 &= tan^{-1}\\frac{\\bar{A}_{ty}}{\\bar{A}_{tz}} \\\\\n\\end{align}\n$$\n\nThus:\n\n$$\n\\begin{align}\nW^{-1} &= P(p_0)R(r_0) \\\\\nW &= R(r_0)^TP(p_0)^T\n\\end{align}\n$$\n\n## Summary\n\nNow that we have the derivations in place, we can estimate the animal's pitch, roll, and heading. Here are the typical steps.\n\n1.  Measure acceleration and magnetism in the tag frame, $A^t$ and $M^t$\n2.  Estimate $W$\n    1.  May use $p_0 = -sin^{-1}\\frac{\\bar{A}_{tx}}{||\\bar{A}_t||}$ and $r_0 = tan^{-1}\\frac{\\bar{A}_{ty}}{\\bar{A}_{tz}}$ if applicable (but remember $W^{-1}=P(p_0)R(r_0)$, not $W=P(p_0)R(r_0)$)\n3.  Convert $A^t$ and $M^t$ to animal frame $A^a=A^tW$, $M^a=M^tW$\n4.  Estimate pitch and roll\n    1.  $\\hat{p}=-sin^{-1} \\frac{A^a_x}{||A^a||}$\n    2.  $\\hat{r} = tan^{-1}~\\frac{A^a_y}{A^a_z}$\n5.  Gimbal $M^a$, to get $M^h = M^a R(\\hat{r})^T P(\\hat{p})^T$\n6.  Estimate heading $\\hat{h} = tan^{-1}(\\frac{M^h_y}{M^h_x}) + d$\n\n## Sanity check\n\nLet's say we have an animal laying flat on the ground. The tag is on the animal's back, to the right of the spine, closer to the tail than the head. So let's say the tag's pitch is 15° and the roll is 30° relative to the animal. In this case, the tag's measured acceleration is\n\n$$\n\\begin{align}\n\\bar{A}_t &= g D^T Q W^{-1} \\\\\n\\bar{A_t} &= g\\begin{bmatrix} 0 & 0 & 1 \\end{bmatrix} I P(\\pi/12)R(\\pi/6) \\\\\n\\bar{A_t} &= g\\begin{bmatrix} 0 & 0 & 1 \\end{bmatrix}P(\\pi/12)R(\\pi/6) \\\\\n\\bar{A_t} &= g\\begin{bmatrix} 0 & 0 & 1 \\end{bmatrix}\n\\begin{bmatrix}\ncos ~ \\pi/12 & 0 & sin ~ \\pi/12 \\\\\n0 & 1 & 0 \\\\\n-sin ~ \\pi/12 & 0 & cos ~ \\pi/12\n\\end{bmatrix}\n\\begin{bmatrix}\n1 & 0 & 0 \\\\\n0 & cos ~ \\pi/6 & -sin ~ \\pi/6 \\\\\n0 & sin ~ \\pi/6 & cos ~ \\pi/6\n\\end{bmatrix} \\\\\n\\bar{A_t} &= g\\begin{bmatrix} -sin~\\pi/12 & 0 & cos~\\pi/12 \\end{bmatrix}\n\\begin{bmatrix}\n1 & 0 & 0 \\\\\n0 & cos ~ \\pi/6 & -sin ~ \\pi/6 \\\\\n0 & sin ~ \\pi/6 & cos ~ \\pi/6\n\\end{bmatrix} \\\\\n\\bar{A_t} &= g\\begin{bmatrix}-sin~\\pi/12 & cos~\\pi/12 ~ sin~\\pi/6 & cos~\\pi/12 ~ cos~\\pi/6\\end{bmatrix} \\\\\n\\bar{A_t} &= g\\begin{bmatrix}-0.259 & 0.483 & 0.837\\end{bmatrix}\n\\end{align}\n$$\n\nLet's estimate $W$.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Acceleration vector\nAt <- 9.8 * c(-0.259, 0.483, 0.837)\nAt_norm <- sqrt(sum(At * At))\n\n# Pitch and roll of W^-1\np0 <- -asin(At[1] / At_norm)\nr0 <- atan2(At[2], At[3])\n\n# Rotation matrix convenience functions\nP <- function(p) {\n  matrix(c(\n    cos(p),  0, sin(p),\n    0,       1, 0,\n    -sin(p), 0, cos(p)\n  ), byrow = TRUE, nrow = 3)\n}\nR <- function(r) {\n  matrix(c(\n    1, 0,      0,\n    0, cos(r), -sin(r),\n    0, sin(r), cos(r)\n  ), byrow = TRUE, nrow = 3)\n}\n\n# W^-1 and W\nWi <- P(p0) %*% R(r0)\nW <- t(Wi)\n\nW\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n          [,1]       [,2]       [,3]\n[1,] 0.9659099  0.0000000 -0.2588785\n[2,] 0.1293906  0.8661339  0.4827734\n[3,] 0.2242234 -0.4998120  0.8366073\n```\n\n\n:::\n:::\n\n\n\nBecause $\\Psi^t=\\Psi^aW$, $A_t = A_aW$, so rotation the animal's acceleration vector by $W$ should give us the original $A_t$.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Animal is only experiencing gravity in the Z axis\nAa <- c(0, 0, 9.8)\n# Rotating At by W should give us Aa\nAa2 <- At %*% W\n\nrbind(Aa = round(as.vector(Aa), 2), \n      Aa2 = round(as.vector(Aa2), 2))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n    [,1] [,2] [,3]\nAa     0    0  9.8\nAa2    0    0  9.8\n```\n\n\n:::\n:::\n\n\n\nBeautiful!\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}