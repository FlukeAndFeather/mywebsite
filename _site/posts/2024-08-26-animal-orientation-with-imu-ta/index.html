<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.43">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Max Czapanskiy">
<meta name="dcterms.date" content="2024-08-30">
<meta name="description" content="Derivations of formulas for estimating pitch, roll, and heading of an animal from a tag with an accelerometer and magnetometer.">

<title>Max Czapanskiy | Ecology and Data Science – Animal orientation with IMU tags</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Max Czapanskiy | Ecology and Data Science</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../teaching.html"> 
<span class="menu-text">Teaching</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../research.html"> 
<span class="menu-text">Research</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../pubs.html"> 
<span class="menu-text">Publications</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../posts.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Animal orientation with IMU tags</h1>
                  <div>
        <div class="description">
          Derivations of formulas for estimating pitch, roll, and heading of an animal from a tag with an accelerometer and magnetometer.
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">biologging</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Max Czapanskiy </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">August 30, 2024</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#reference-frames" id="toc-reference-frames" class="nav-link active" data-scroll-target="#reference-frames">Reference frames</a></li>
  <li><a href="#rotation-matrices" id="toc-rotation-matrices" class="nav-link" data-scroll-target="#rotation-matrices">Rotation matrices</a></li>
  <li><a href="#accelerometers-gravity-pitch-and-roll" id="toc-accelerometers-gravity-pitch-and-roll" class="nav-link" data-scroll-target="#accelerometers-gravity-pitch-and-roll">Accelerometers, gravity, pitch, and roll</a>
  <ul class="collapse">
  <li><a href="#what-do-accelerometers-measure" id="toc-what-do-accelerometers-measure" class="nav-link" data-scroll-target="#what-do-accelerometers-measure">What do accelerometers measure?</a></li>
  <li><a href="#estimating-pitch-and-roll" id="toc-estimating-pitch-and-roll" class="nav-link" data-scroll-target="#estimating-pitch-and-roll">Estimating pitch and roll</a></li>
  </ul></li>
  <li><a href="#magnetometers-earths-magnetic-field-and-heading" id="toc-magnetometers-earths-magnetic-field-and-heading" class="nav-link" data-scroll-target="#magnetometers-earths-magnetic-field-and-heading">Magnetometers, Earth’s magnetic field, and heading</a>
  <ul class="collapse">
  <li><a href="#what-do-magnetometers-measure" id="toc-what-do-magnetometers-measure" class="nav-link" data-scroll-target="#what-do-magnetometers-measure">What do magnetometers measure?</a></li>
  <li><a href="#estimating-heading" id="toc-estimating-heading" class="nav-link" data-scroll-target="#estimating-heading">Estimating heading</a></li>
  </ul></li>
  <li><a href="#what-about-w" id="toc-what-about-w" class="nav-link" data-scroll-target="#what-about-w">What about <span class="math inline">\(W\)</span>?</a></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary">Summary</a></li>
  <li><a href="#sanity-check" id="toc-sanity-check" class="nav-link" data-scroll-target="#sanity-check">Sanity check</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<p>Every 6-18 months, my friend Jessie and I try to remember the linear algebra required to estimate animal orientation (pitch, roll, heading) from an accelerometer/magnetometer tag. This usually involves a 2-3 hour Zoom call, frantic whiteboard activity, and moderate hair loss. In the hopes of breaking this stressful cycle, here are my notes about the subject.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>This post is my version of Mark Johnson’s notes from the 2011 fine-scale animal movement workshop in Hobart, Australia. The bulk of the material is his. My changes include different axis conventions, expanded derivations where I found myself lost, and removal of some material about hardware.</p>
</div>
</div>
<section id="reference-frames" class="level2">
<h2 class="anchored" data-anchor-id="reference-frames">Reference frames</h2>
<p>A major source of confusion is often the reference frame. We’re going to describe orientation as a rotation. The reference frame describes what it’s a rotation <em>from</em>. A pitch of 45° means something intuitively (facing halfway from the horizon to straight up), but mathematically it only has meaning if we specify what we’re pitching 45° relative to. Enter reference frames.</p>
<p>We use three reference frames, which we call <span class="math inline">\(\Psi\)</span>. One for the world at large (AKA navigation, <span class="math inline">\(\Psi^n\)</span>), one for the animal’s body (<span class="math inline">\(\Psi^a\)</span>), and a third for the tag (<span class="math inline">\(\Psi^t\)</span>).</p>
<p><span class="math display">\[
\begin{align}
\Psi^n &amp;= \begin{bmatrix}
N ~ E ~ D
\end{bmatrix} \\
\Psi^a &amp;= \begin{bmatrix}
X^a ~ Y^a ~ Z^a
\end{bmatrix} \\
\Psi^t &amp;= \begin{bmatrix}
X^t ~ Y^t ~ Z^t
\end{bmatrix}
\end{align}
\]</span></p>
<p>Where <span class="math inline">\(N\)</span>, <span class="math inline">\(E\)</span>, and <span class="math inline">\(D\)</span> represent the vectors for north, east, and down, respectively. <span class="math inline">\(X^a\)</span> is the longitudinal axis of the animal (along the spine), <span class="math inline">\(Y^a\)</span> is the transverse axis (left to right), and <span class="math inline">\(Z^a\)</span> is the dorso-ventral axis. Same for <span class="math inline">\(X^t\)</span>, <span class="math inline">\(Y^t\)</span>, <span class="math inline">\(Z^t\)</span>, but for the tag instead of the animal.</p>
<p>Because the vectors <span class="math inline">\(N\)</span>, <span class="math inline">\(X^a\)</span>, etc are 3x1, these reference frames are all 3x3 matrices. When we align with their point of view, we define them to be the identity matrix, <span class="math inline">\(I\)</span>.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p><span class="math inline">\(\Psi^n\)</span> is controversial within the animal tagging community. A conventional right-hand rule reference frame would be <span class="math inline">\(\begin{bmatrix} N ~ W ~ U \end{bmatrix}\)</span>, not <span class="math inline">\(\begin{bmatrix} N ~ E ~ D \end{bmatrix}\)</span>. Hold your hand out and stick out your thumb and first two fingers all at right angles (pointer forward, thumb up, middle finger left). Let your pointer be <span class="math inline">\(N\)</span>, your middle finger be <span class="math inline">\(W\)</span>, and your thumb be <span class="math inline">\(U\)</span>. Notice how comfortable that is? Unfortunately, the math makes it such that <em>positive pitch means down</em> in this orientation. Most people find that counter-intuitive. We have two options to change that: adopt a left-hand rule system <span class="math inline">\(\begin{bmatrix} N ~ E ~ U \end{bmatrix}\)</span> or an “upside down” right-hand rule <span class="math inline">\(\begin{bmatrix} N ~ E ~ D \end{bmatrix}\)</span>. Within the marine vertebrate research community, there’s a split. Some use the left-hand rule <span class="math inline">\(\begin{bmatrix} N ~ E ~ U \end{bmatrix}\)</span> (TODO: cite 10.1109/JOE.2002.808212) and others the upside-down right-hand rule <span class="math inline">\(\begin{bmatrix} N ~ E ~ D \end{bmatrix}\)</span> (TODO: cite 10.1186/s40317-021-00256-w). I find keeping the right-hand rule makes more sense to me personally, so that’s what I’ll use here.</p>
</div>
</div>
</section>
<section id="rotation-matrices" class="level2">
<h2 class="anchored" data-anchor-id="rotation-matrices">Rotation matrices</h2>
<p>Rotations are defined using Euler angles: the familiar pitch, roll, and heading. We define two important rotation matrices: <span class="math inline">\(\boldsymbol{Q}\)</span> and <span class="math inline">\(\boldsymbol{W}\)</span>.</p>
<p><span class="math inline">\(\boldsymbol{Q}\)</span> is the rotation matrix describing the orientation of the animal frame relative to the navigation frame.</p>
<p><span class="math display">\[
\Psi^a = \Psi^n \boldsymbol{Q}
\]</span></p>
<p>That’s often tricky to understand, so I’ll repeat it. Our estimate of the animal’s body orientation is a rotation matrix. <span class="math inline">\(\boldsymbol{Q}\)</span> itself is the product of three other rotation matrices, which define the pitch, roll, and heading of the animal. Therefore, <span class="math inline">\(\boldsymbol{Q}\)</span> is a biologically meaningful variable that we’re interested in studying.</p>
<p><span class="math inline">\(\boldsymbol{W}\)</span> is the rotation matrix describing the animal’s orientation relative to the tag.</p>
<p><span class="math display">\[
\Psi^a = \Psi^t \boldsymbol{W}
\]</span></p>
<p>Like <span class="math inline">\(\boldsymbol{Q}\)</span>, <span class="math inline">\(\boldsymbol{W}\)</span> is the product of three rotations, which yaw, pitch, and roll the tag relative to the animal. Unlike <span class="math inline">\(\boldsymbol{Q}\)</span>, <span class="math inline">\(\boldsymbol{W}\)</span> is not biologically meaningful. However, we need <span class="math inline">\(\boldsymbol{W}\)</span> to figure out <span class="math inline">\(\boldsymbol{Q}\)</span> because we can’t measure <span class="math inline">\(\boldsymbol{Q}\)</span> directly.</p>
<p>What does a rotation matrix actually look like? There are three we use often, which are the rotations around the reference frame axes themselves. Hold out your hand in <span class="math inline">\(\begin{bmatrix} N ~ E ~ D \end{bmatrix}\)</span> orientation. Rotate forward to pitch your pointer down. Which axis did you rotate <em>around</em>? Your thumb is pointing in a new direction, too, but your middle finger (which represents <span class="math inline">\(E\)</span>, the y-axis) is still pointing to the right. So we see <em>pitch is a</em> <em>rotation around the y-axis</em>. The same is also true for roll (around the x-axis) and yaw (around the z-axis). Mathematically, they look like this:</p>
<p><span class="math display">\[
\begin{align}
Y(\gamma) &amp;= \begin{bmatrix}
cos ~ \gamma &amp; -sin ~ \gamma &amp; 0 \\
sin ~ \gamma &amp; cos ~ \gamma &amp; 0 \\
0 &amp; 0 &amp; 1
\end{bmatrix} \\
P(p) &amp;= \begin{bmatrix}
cos ~ p &amp; 0 &amp; sin ~ p \\
0 &amp; 1 &amp; 0 \\
-sin ~ p &amp; 0 &amp; cos ~ p
\end{bmatrix} \\
R(r) &amp;= \begin{bmatrix}
1 &amp; 0 &amp; 0 \\
0 &amp; cos ~ r &amp; -sin ~ r \\
0 &amp; sin ~ r &amp; cos ~ r
\end{bmatrix}
\end{align}
\]</span></p>
<p>Where <span class="math inline">\(Y\)</span>, <span class="math inline">\(P\)</span>, and <span class="math inline">\(R\)</span> are the yaw, pitch, and roll matrices, respectively. <span class="math inline">\(\gamma\)</span>, <span class="math inline">\(p\)</span>, and <span class="math inline">\(r\)</span> are the yaw, pitch, and roll angles themselves. They’re not symmetrical matrices, which means matrix multiplication won’t be commutative, so order matters. We always apply them in the order <span class="math inline">\(YPR\)</span>. This has the effect of rotating around the local axes, those of the thing itself being rotated. The reverse order, <span class="math inline">\(RPY\)</span> applies the rotations relative to the global axes. If that doesn’t makes sense don’t worry about it, just remember for <span class="math inline">\(Q\)</span> and <span class="math inline">\(W\)</span> we always rotate in the order <span class="math inline">\(YPR\)</span>.</p>
</section>
<section id="accelerometers-gravity-pitch-and-roll" class="level2">
<h2 class="anchored" data-anchor-id="accelerometers-gravity-pitch-and-roll">Accelerometers, gravity, pitch, and roll</h2>
<section id="what-do-accelerometers-measure" class="level3">
<h3 class="anchored" data-anchor-id="what-do-accelerometers-measure">What do accelerometers measure?</h3>
<p>Accelerometers measure acceleration. Acceleration can mean a few different things, and the particular kind of acceleration measured by accelerometers is not the intuitive one for most of us.</p>
<p>Imagine a tag at rest on a table. Is it accelerating? Instinctively, we think of acceleration <em>relative to a coordinate system</em>. And since the tag’s position isn’t changing, we would say it isn’t accelerating. However, an accelerometer would measure an acceleration of 9.8 m s<sup>-2</sup> straight down. Similarly, if we went to the top of a tower and dropped a tag, we would observe it accelerating at 9.8 m s<sup>-2</sup> straight down, but the accelerometer would read 0.</p>
<p>These counter-intuitive readings are because accelerometers measure <em>proper acceleration</em>, which is relative to the inertial frame of reference. We don’t need to dive into the precise physics of inertial reference frames. In short, here’s the intuition that will help: the accelerometer readings are relative to an object in free fall.</p>
</section>
<section id="estimating-pitch-and-roll" class="level3">
<h3 class="anchored" data-anchor-id="estimating-pitch-and-roll">Estimating pitch and roll</h3>
<p>We can use the accelerometer readings to detect the pitch and roll of an object at rest. At rest, the only force is gravity, which is aligned downwards, along <span class="math inline">\(D\)</span>. So the acceleration measured by the tag is:</p>
<p><span class="math display">\[
A^t = g D^T \Psi^t
\]</span></p>
<p>Where <span class="math inline">\(A^t\)</span> is the 1x3 vector of accelerometer readings <span class="math inline">\(\begin{bmatrix} a_x ~ a_y ~ a_z \end{bmatrix}\)</span>. <span class="math inline">\(g\)</span> is the strength of gravitational acceleration (about 9.8 m s<sup>-2</sup>). Notice the T in <span class="math inline">\(D^T\)</span> is capitalized. We use lower case <span class="math inline">\(t\)</span> to indicate something to do with the tag e.g., <span class="math inline">\(\Psi^t\)</span>. Capital T here means we’re transposing the column vector representing “down” into a row vector. That just makes the math easier.</p>
<p>We have a problem here, though. <span class="math inline">\(A^t\)</span> is measured in the tag’s reference frame (hence the <span class="math inline">\(\Psi^t\)</span>), but down <span class="math inline">\(D^T\)</span> is defined in the navigation frame. Let’s pretend for a second the tag frame is aligned with the animal frame (i.e., <span class="math inline">\(\Psi^a = \Psi^t\)</span>) . Then, recall our reference frame definition <span class="math inline">\(\Psi^a = \Psi^n Q\)</span>. Substituting that in, we get:</p>
<p><span class="math display">\[
\begin{align}
A^t &amp;= g D^T \Psi^t \\
A^t &amp;= g D^T \Psi^n Q \\
A^t &amp;= g \begin{bmatrix} 0 ~ 0 ~ 1 \end{bmatrix}Q
\end{align}
\]</span>That works because, by definition, <span class="math inline">\(D^T \Psi^n = \begin{bmatrix}0 ~ 0 ~ 1\end{bmatrix}\)</span>. That’s how we defined “down” in the navigational reference frame.</p>
<p>Now recall the rotation matrices for yaw, pitch, and roll, and that <span class="math inline">\(Q\)</span> is the composition of those three. When we substitute in <span class="math inline">\(Y\)</span>, <span class="math inline">\(D\)</span> will just cancel it out. This should make sense intuitively: gravity’s effect on your acceleration is the same whether you face north, south, east, or west. Then we can solve for <span class="math inline">\(A^t\)</span> based on <span class="math inline">\(P\)</span> and <span class="math inline">\(R\)</span>.</p>
<p><span class="math display">\[
\begin{align}
A^t &amp;= g \begin{bmatrix} 0 ~ 0 ~ 1 \end{bmatrix} Q \\
A^t &amp;= g \begin{bmatrix} 0 ~ 0 ~ 1 \end{bmatrix} Y(\gamma) P(p) R(r) \\
A^t &amp;= g \begin{bmatrix} 0 ~ 0 ~ 1 \end{bmatrix} \begin{bmatrix}
cos ~ \gamma &amp; -sin ~ \gamma &amp; 0 \\
sin ~ \gamma &amp; cos ~ \gamma &amp; 0 \\
0 &amp; 0 &amp; 1
\end{bmatrix} P(p) R(r) \\
A^t &amp;= g \begin{bmatrix} 0 ~ 0 ~ 1 \end{bmatrix} P(p) R(r) \\
A^t &amp;= g \begin{bmatrix} 0 ~ 0 ~ 1 \end{bmatrix} \begin{bmatrix}
cos ~ p &amp; 0 &amp; sin ~ p \\
0 &amp; 1 &amp; 0 \\
-sin ~ p &amp; 0 &amp; cos ~ p
\end{bmatrix} \begin{bmatrix}
1 &amp; 0 &amp; 0 \\
0 &amp; cos ~ r &amp; -sin ~ r \\
0 &amp; sin ~ r &amp; cos ~ r
\end{bmatrix} \\
A^t &amp;= g \begin{bmatrix} -sin~p &amp; 0 &amp; cos~p \end{bmatrix} \begin{bmatrix}
1 &amp; 0 &amp; 0 \\
0 &amp; cos ~ r &amp; -sin ~ r \\
0 &amp; sin ~ r &amp; cos ~ r
\end{bmatrix} \\
A^t &amp;= g \begin{bmatrix} -sin~p &amp; -cos~p~sin~r &amp; -cos~p~cos~r \end{bmatrix}  \\
\end{align}
\]</span></p>
<p>Now we can solve for <span class="math inline">\(p\)</span> and <span class="math inline">\(r\)</span>, our pitch and roll. We’ll call them <span class="math inline">\(\hat{p}\)</span> and <span class="math inline">\(\hat{r}\)</span> to indicate they’re estimates. First, <span class="math inline">\(p\)</span>:</p>
<p><span class="math display">\[
\begin{align}
a_x &amp;= -g ~ sin ~ \hat{p} \\
sin ~ \hat{p} &amp;= \frac{a_x}{-g} \\
\hat{p} &amp;= -sin^{-1} \frac{a_x}{g}
\end{align}
\]</span></p>
<p>Note: remember <span class="math inline">\(sin ~ {-x} = -sin ~ x\)</span>. The formula for <span class="math inline">\(\hat{p}\)</span> is correct for an object at rest, but usually we’re tracking a moving animal. We can improve our estimate if we divide by the norm of the whole acceleration vector, rather than dividing by g. So in practice, <span class="math inline">\(\hat{p}\)</span> will be:</p>
<p><span class="math display">\[
\hat{p} = -sin^{-1} \frac{a_x}{||A^t||}
\]</span></p>
<p>Roll is a bit trickier, but still doable. Start by dividing <span class="math inline">\(a_y\)</span> by <span class="math inline">\(a_z\)</span>.</p>
<p><span class="math display">\[
\begin{align}
\frac{a_y}{a_z} &amp;= \frac{-cos~\hat{p}~sin~\hat{r}}{-cos~\hat{p}~cos~\hat{r}} \\
\frac{a_y}{a_z} &amp;= \frac{sin~\hat{r}}{cos~\hat{r}} \\
\frac{a_y}{a_z} &amp;= tan~\hat{r} \\
\hat{r} &amp;= tan^{-1}~\frac{a_y}{a_z} \\
\end{align}
\]</span></p>
</section>
</section>
<section id="magnetometers-earths-magnetic-field-and-heading" class="level2">
<h2 class="anchored" data-anchor-id="magnetometers-earths-magnetic-field-and-heading">Magnetometers, Earth’s magnetic field, and heading</h2>
<section id="what-do-magnetometers-measure" class="level3">
<h3 class="anchored" data-anchor-id="what-do-magnetometers-measure">What do magnetometers measure?</h3>
<p>From accelerometers we can estimate pitch and roll, but we need an alternative to estimate heading. The Earth’s magnetic field, roughly speaking, points up at the magnetic south pole, is parallel to the earth’s surface around the equator, and points down at the magnetic north pole. So unlike gravity, which always points down at the same strength, the magnetic field vector changes depending on where you are<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>. We usually call the magnetic field <span class="math inline">\(B\)</span> and it’s defined by three parameters: <span class="math inline">\(b\)</span> (the strength of the field), <span class="math inline">\(i\)</span> (inclination of the field, or the angle it’s pointing below the horizon), and <span class="math inline">\(d\)</span> (declination of the field, or the angle of magnetic north east of true north). Using rotation matrices, <span class="math inline">\(B\)</span> is:</p>
<p><span class="math display">\[
\begin{align}
B &amp;= b N^T \Psi^n P(-i) Y(d)
\end{align}
\]</span></p>
<p><span class="math inline">\(b N^T \Psi^n\)</span> means a vector with magnitude <span class="math inline">\(b\)</span> pointing north in the navigational frame. Then we incline the field by pitching it <span class="math inline">\(i\)</span> below the horizon and yaw it <span class="math inline">\(d\)</span> degrees east. <span class="math inline">\(-i\)</span> because in our navigational reference frame negative pitch means down, remember? Also, this is the only time <span class="math inline">\(P\)</span> will be applied before <span class="math inline">\(Y\)</span>. That’s because these are global rotations, not local. You’ll never do this with tag or animal rotations; those are local rotations<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>. Solving for <span class="math inline">\(B\)</span>, we get:</p>
<p><span class="math display">\[
\begin{align}
B &amp;= b N^T \Psi^n P(-i) Y(d) \\
B &amp;= b N^T \Psi^n
\begin{bmatrix}
cos ~ {-i} &amp; 0 &amp; sin ~ {-i} \\
0 &amp; 1 &amp; 0 \\
-sin ~ {-i} &amp; 0 &amp; cos ~ {-i}
\end{bmatrix}
\begin{bmatrix}
cos ~ d &amp; -sin ~ d &amp; 0 \\
sin ~ d &amp; cos ~ d &amp; 0 \\
0 &amp; 0 &amp; 1
\end{bmatrix} \\
B &amp;= b N^T \Psi^n
\begin{bmatrix}
cos ~ i &amp; 0 &amp; -sin ~ i \\
0 &amp; 1 &amp; 0 \\
sin ~ i &amp; 0 &amp; cos ~ i
\end{bmatrix}
\begin{bmatrix}
cos ~ d &amp; -sin ~ d &amp; 0 \\
sin ~ d &amp; cos ~ d &amp; 0 \\
0 &amp; 0 &amp; 1
\end{bmatrix} \\
B &amp;= b \begin{bmatrix} 1 &amp; 0 &amp; 0 \end{bmatrix}
\begin{bmatrix}
cos ~ i &amp; 0 &amp; -sin ~ i \\
0 &amp; 1 &amp; 0 \\
sin ~ i &amp; 0 &amp; cos ~ i
\end{bmatrix}
\begin{bmatrix}
cos ~ d &amp; -sin ~ d &amp; 0 \\
sin ~ d &amp; cos ~ d &amp; 0 \\
0 &amp; 0 &amp; 1
\end{bmatrix} \\
B &amp;= b \begin{bmatrix} cos ~ i &amp; 0 &amp; -sin ~ i \end{bmatrix}
\begin{bmatrix}
cos ~ d &amp; -sin ~ d &amp; 0 \\
sin ~ d &amp; cos ~ d &amp; 0 \\
0 &amp; 0 &amp; 1
\end{bmatrix} \\
B &amp;= b \begin{bmatrix} cos~i ~ cos~d &amp; -cos~i ~ sin~d &amp; -sin ~ i \end{bmatrix} \\
\end{align}
\]</span></p>
<p>A little more complicated than just <span class="math inline">\(\begin{bmatrix} 0 &amp; 0 &amp; g \end{bmatrix}\)</span>, isn’t it? But it’s essential for figuring out our heading.</p>
</section>
<section id="estimating-heading" class="level3">
<h3 class="anchored" data-anchor-id="estimating-heading">Estimating heading</h3>
<p>When you use a compass to find north, it’s important to lay it flat. You may have seen compasses where the needle floats in a bubble, which keeps it level despite minor pitches and rolls. That’s called <em>gimbaling</em> the compass. We need to do the same for our 3d magnetometer readings. Unlike a hand-held compass, we can’t do that mechanically. Instead we use <span class="math inline">\(\hat{p}\)</span> and <span class="math inline">\(\hat{r}\)</span>, which we got from the accelerometer, to rotate the the magnetometer readings to the horizontal. If <span class="math inline">\(M^a\)</span> is the magnetometer reading on the animal, we’ll call the gimbaled version <span class="math inline">\(M^h\)</span>, where <span class="math inline">\(h\)</span> means horizontal.</p>
<p><span class="math display">\[
\begin{align}
M^h &amp;= M^a (P(\hat{p}) R(\hat{r}))^{-1} \\
M^h &amp;= M^a R(\hat{r})^{-1} P(\hat{p})^{-1} \\
M^h &amp;= M^a R(\hat{r})^T P(\hat{p})^T \\
\end{align}
\]</span></p>
<p>In matrix multiplication, we get the inverse of a product <span class="math inline">\((AB)^{-1}\)</span> by reversing and inverting the matrices <span class="math inline">\(B^{-1}A^{-1}\)</span>. That’s why roll and pitch get flipped around. And rotation matrices have the convenient property where their inverse is their transpose.</p>
<p>Now that we’ve removed the pitch and roll of the magnetometer to get <span class="math inline">\(M^h\)</span>, the magnetic field is only a function of the animal’s heading, which we estimate as <span class="math inline">\(\hat{h}\)</span>.</p>
<p><span class="math display">\[
\begin{align}
M^h &amp;= B Y(\hat{h}) \\
M^h &amp;= b \begin{bmatrix} cos~i ~ cos~d &amp; -cos~i ~ sin~d &amp; -sin ~ i \end{bmatrix} \begin{bmatrix}
cos ~ \hat{h} &amp; -sin ~ \hat{h} &amp; 0 \\
sin ~ \hat{h} &amp; cos ~ \hat{h} &amp; 0 \\
0 &amp; 0 &amp; 1
\end{bmatrix} \\
M^h &amp;= b\begin{bmatrix}
cos~i ~ cos~d ~ cos~\hat{h} - cos~i ~ sin~d ~ sin~\hat{h} &amp;
-cos~i ~ cos~d ~ sin~\hat{h} - cos~i ~ sin~d ~ cos~\hat{h} &amp;
-sin~i
\end{bmatrix} \\
M^h &amp;= b\begin{bmatrix}
cos~i (cos~d ~ cos~\hat{h} - sin~d ~ sin~\hat{h}) &amp;
cos~i (cos~d ~ sin~\hat{h} + sin~d ~ cos~\hat{h}) &amp;
-sin~i
\end{bmatrix} \\
\end{align}
\]</span></p>
<p>Now divide <span class="math inline">\(M^h_x\)</span> by <span class="math inline">\(M^h_y\)</span>.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>The following requires the trigonometric identities for differences of angles, which you might not know off the top of your head. They are:</p>
<p><span class="math display">\[
\begin{align}
sin(\alpha - \beta) &amp;= sin~\alpha ~ cos~\beta - cos~\alpha ~ sin~\beta \\
cos(\alpha - \beta) &amp;= cos~\alpha ~ cos~\beta - sin~\alpha ~ sin~\beta
\end{align}
\]</span></p>
</div>
</div>
<p><span class="math display">\[
\begin{align}
\frac{M^h_y}{M^h_x} &amp;= \frac{cos~i (sin~\hat{h} ~ cos~d - cos~\hat{h} ~ sin~d)}{cos~i (cos~d ~ cos~\hat{h} + sin~d ~ sin~\hat{h})} \\
\frac{M^h_y}{M^h_x} &amp;= \frac{sin~\hat{h} ~ cos~d - cos~\hat{h} ~ sin~d}{cos~d ~ cos~\hat{h} - sin~d ~ sin~\hat{h}} \\
\frac{M^h_y}{M^h_x} &amp;= \frac{sin(\hat{h} - d)}{cos(\hat{h} - d)} \\
\frac{M^h_y}{M^h_x} &amp;= tan(\hat{h} - d) \\
\hat{h} - d &amp;= tan^{-1}(\frac{M^h_y}{M^h_x}) \\
\hat{h} &amp;= tan^{-1}(\frac{M^h_y}{M^h_x}) + d \\
\end{align}
\]</span></p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>This is different than Mark Johnson’s result and I haven’t figure out why yet. I may have defined <span class="math inline">\(B\)</span> differently, perhaps? But this way makes more sense to me because I can see how it uses declination to correct for the difference between magnetic and true north. I need to ask someone about this!</p>
</div>
</div>
</section>
</section>
<section id="what-about-w" class="level2">
<h2 class="anchored" data-anchor-id="what-about-w">What about <span class="math inline">\(W\)</span>?</h2>
<p>Up to this point we have operated under the assumption the tag and animal reference frames were aligned. That’s often not the case, and figuring out <span class="math inline">\(W\)</span> can be tricky! If the tag is attached to an animal in hand, as is often the case for seabirds and pinnipeds, then <span class="math inline">\(W\)</span> may be very close to <span class="math inline">\(I\)</span>. However, if the tag is attached to an animal in motion, which is common in cetacean studies, <span class="math inline">\(W\)</span> could be just about anything. The full suite of methods for estimating <span class="math inline">\(W\)</span> from tag data itself is outside the scope of this blog post, but I will show how to derive <span class="math inline">\(W\)</span> on two conditions. 1) There’s a period of time when the animal’s orientation is known (i.e., we know <span class="math inline">\(Q\)</span>) and 2) the yaw of the tag with respect to the animal is 0. These conditions are typically met in the animal-in-hand scenario, where the tag is manually attached along the longitudinal axis of the animal, but the curvature of the animal’s body may pitch or roll the tag away from <span class="math inline">\(I\)</span>.</p>
<p>Let <span class="math inline">\(\bar{A}_t\)</span> be the mean acceleration reading during the period of known animal orientation. Let’s also say that during this time, the animal’s pitch and roll relative to the navigational frame are 0 (i.e., it’s laying flat). Define the pitch and roll of the tag relative to the animal as <span class="math inline">\(p_0\)</span> and <span class="math inline">\(r_0\)</span>, respectively. Notice <span class="math inline">\(p_0\)</span> and <span class="math inline">\(r_0\)</span> are the orientation of the <em>tag</em> relative to the <em>animal</em>, so they define <span class="math inline">\(W^{-1}\)</span>, not <span class="math inline">\(W\)</span>. Then:</p>
<p><span class="math display">\[
\begin{align}
\bar{A}_t &amp;= g D^T Q W^{-1} \\
Q &amp;= Y(\gamma)P(0)R(0) \\
W^{-1} &amp;= Y(0)P(p_0)R(r_0) \\
\bar{A}_t &amp;= g \begin{bmatrix}0 &amp; 0 &amp; 1\end{bmatrix} Y(\gamma)P(0)R(0) Y(0)P(p_0)R(r_0) \\
\bar{A}_t &amp;= g \begin{bmatrix}0 &amp; 0 &amp; 1\end{bmatrix} P(p_0)R(r_0) \\
\bar{A}_t &amp;= g \begin{bmatrix}0 &amp; 0 &amp; 1\end{bmatrix}
\begin{bmatrix}
cos ~ p_0 &amp; 0 &amp; sin ~ p_0 \\
0 &amp; 1 &amp; 0 \\
-sin ~ p_0 &amp; 0 &amp; cos ~ p_0
\end{bmatrix}
\begin{bmatrix}
1 &amp; 0 &amp; 0 \\
0 &amp; cos ~ r_0 &amp; -sin ~ r_0 \\
0 &amp; sin ~ r_0 &amp; cos ~ r_0
\end{bmatrix} \\
\bar{A}_t &amp;= g \begin{bmatrix}-sin ~ p_0 &amp; 0 &amp; cos ~ p_0\end{bmatrix}  
\begin{bmatrix}
1 &amp; 0 &amp; 0 \\
0 &amp; cos ~ r_0 &amp; -sin ~ r_0 \\
0 &amp; sin ~ r_0 &amp; cos ~ r_0
\end{bmatrix} \\
\bar{A}_t &amp;= g \begin{bmatrix}
-sin~p_0 &amp; cos~p_0~sin~r_0 &amp; cos~p_0~cos~r_0
\end{bmatrix}
\end{align}
\]</span></p>
<p>Now we can get <span class="math inline">\(p_0\)</span> from <span class="math inline">\(\bar{A}_{tx}\)</span> and <span class="math inline">\(r_0\)</span> from the ratio of <span class="math inline">\(\bar{A}_{ty}\)</span> and <span class="math inline">\(\bar{A}_{tz}\)</span>.</p>
<p><span class="math display">\[
\begin{align}
\bar{A}_{tx} &amp;= -g~sin~p_0 \\
p_0 &amp;= -sin^{-1}\frac{\bar{A}_{tx}}{g}
\end{align}
\]</span></p>
<p>Using the same correction as before, we actually use <span class="math inline">\(p_0 = -sin^{-1}\frac{\bar{A}_{tx}}{||\bar{A}_t||}\)</span>.</p>
<p><span class="math display">\[
\begin{align}
\frac{\bar{A}_{ty}}{\bar{A}_{tz}} &amp;= \frac{cos~p_0 ~ sin~r_0}{cos~p_0 ~ cos~r_0} \\
\frac{\bar{A}_{ty}}{\bar{A}_{tz}} &amp;= \frac{sin~r_0}{cos~r_0} \\
\frac{\bar{A}_{ty}}{\bar{A}_{tz}} &amp;= tan(r_0) \\
r_0 &amp;= tan^{-1}\frac{\bar{A}_{ty}}{\bar{A}_{tz}} \\
\end{align}
\]</span></p>
<p>Thus:</p>
<p><span class="math display">\[
\begin{align}
W^{-1} &amp;= P(p_0)R(r_0) \\
W &amp;= R(r_0)^TP(p_0)^T
\end{align}
\]</span></p>
</section>
<section id="summary" class="level2">
<h2 class="anchored" data-anchor-id="summary">Summary</h2>
<p>Now that we have the derivations in place, we can estimate the animal’s pitch, roll, and heading. Here are the typical steps.</p>
<ol type="1">
<li>Measure acceleration and magnetism in the tag frame, <span class="math inline">\(A^t\)</span> and <span class="math inline">\(M^t\)</span></li>
<li>Estimate <span class="math inline">\(W\)</span>
<ol type="1">
<li>May use <span class="math inline">\(p_0 = -sin^{-1}\frac{\bar{A}_{tx}}{||\bar{A}_t||}\)</span> and <span class="math inline">\(r_0 = tan^{-1}\frac{\bar{A}_{ty}}{\bar{A}_{tz}}\)</span> if applicable (but remember <span class="math inline">\(W^{-1}=P(p_0)R(r_0)\)</span>, not <span class="math inline">\(W=P(p_0)R(r_0)\)</span>)</li>
</ol></li>
<li>Convert <span class="math inline">\(A^t\)</span> and <span class="math inline">\(M^t\)</span> to animal frame <span class="math inline">\(A^a=A^tW\)</span>, <span class="math inline">\(M^a=M^tW\)</span></li>
<li>Estimate pitch and roll
<ol type="1">
<li><span class="math inline">\(\hat{p}=-sin^{-1} \frac{A^a_x}{||A^a||}\)</span></li>
<li><span class="math inline">\(\hat{r} = tan^{-1}~\frac{A^a_y}{A^a_z}\)</span></li>
</ol></li>
<li>Gimbal <span class="math inline">\(M^a\)</span>, to get <span class="math inline">\(M^h = M^a R(\hat{r})^T P(\hat{p})^T\)</span></li>
<li>Estimate heading <span class="math inline">\(\hat{h} = tan^{-1}(\frac{M^h_y}{M^h_x}) + d\)</span></li>
</ol>
</section>
<section id="sanity-check" class="level2">
<h2 class="anchored" data-anchor-id="sanity-check">Sanity check</h2>
<p>Let’s say we have an animal laying flat on the ground. The tag is on the animal’s back, to the right of the spine, closer to the tail than the head. So let’s say the tag’s pitch is 15° and the roll is 30° relative to the animal. In this case, the tag’s measured acceleration is</p>
<p><span class="math display">\[
\begin{align}
\bar{A}_t &amp;= g D^T Q W^{-1} \\
\bar{A_t} &amp;= g\begin{bmatrix} 0 &amp; 0 &amp; 1 \end{bmatrix} I P(\pi/12)R(\pi/6) \\
\bar{A_t} &amp;= g\begin{bmatrix} 0 &amp; 0 &amp; 1 \end{bmatrix}P(\pi/12)R(\pi/6) \\
\bar{A_t} &amp;= g\begin{bmatrix} 0 &amp; 0 &amp; 1 \end{bmatrix}
\begin{bmatrix}
cos ~ \pi/12 &amp; 0 &amp; sin ~ \pi/12 \\
0 &amp; 1 &amp; 0 \\
-sin ~ \pi/12 &amp; 0 &amp; cos ~ \pi/12
\end{bmatrix}
\begin{bmatrix}
1 &amp; 0 &amp; 0 \\
0 &amp; cos ~ \pi/6 &amp; -sin ~ \pi/6 \\
0 &amp; sin ~ \pi/6 &amp; cos ~ \pi/6
\end{bmatrix} \\
\bar{A_t} &amp;= g\begin{bmatrix} -sin~\pi/12 &amp; 0 &amp; cos~\pi/12 \end{bmatrix}
\begin{bmatrix}
1 &amp; 0 &amp; 0 \\
0 &amp; cos ~ \pi/6 &amp; -sin ~ \pi/6 \\
0 &amp; sin ~ \pi/6 &amp; cos ~ \pi/6
\end{bmatrix} \\
\bar{A_t} &amp;= g\begin{bmatrix}-sin~\pi/12 &amp; cos~\pi/12 ~ sin~\pi/6 &amp; cos~\pi/12 ~ cos~\pi/6\end{bmatrix} \\
\bar{A_t} &amp;= g\begin{bmatrix}-0.259 &amp; 0.483 &amp; 0.837\end{bmatrix}
\end{align}
\]</span></p>
<p>Let’s estimate <span class="math inline">\(W\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Acceleration vector</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>At <span class="ot">&lt;-</span> <span class="fl">9.8</span> <span class="sc">*</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.259</span>, <span class="fl">0.483</span>, <span class="fl">0.837</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>At_norm <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">sum</span>(At <span class="sc">*</span> At))</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Pitch and roll of W^-1</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>p0 <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fu">asin</span>(At[<span class="dv">1</span>] <span class="sc">/</span> At_norm)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>r0 <span class="ot">&lt;-</span> <span class="fu">atan2</span>(At[<span class="dv">2</span>], At[<span class="dv">3</span>])</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Rotation matrix convenience functions</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>P <span class="ot">&lt;-</span> <span class="cf">function</span>(p) {</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">matrix</span>(<span class="fu">c</span>(</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cos</span>(p),  <span class="dv">0</span>, <span class="fu">sin</span>(p),</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    <span class="dv">0</span>,       <span class="dv">1</span>, <span class="dv">0</span>,</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span><span class="fu">sin</span>(p), <span class="dv">0</span>, <span class="fu">cos</span>(p)</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>  ), <span class="at">byrow =</span> <span class="cn">TRUE</span>, <span class="at">nrow =</span> <span class="dv">3</span>)</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>R <span class="ot">&lt;-</span> <span class="cf">function</span>(r) {</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">matrix</span>(<span class="fu">c</span>(</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span>, <span class="dv">0</span>,      <span class="dv">0</span>,</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>    <span class="dv">0</span>, <span class="fu">cos</span>(r), <span class="sc">-</span><span class="fu">sin</span>(r),</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>    <span class="dv">0</span>, <span class="fu">sin</span>(r), <span class="fu">cos</span>(r)</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>  ), <span class="at">byrow =</span> <span class="cn">TRUE</span>, <span class="at">nrow =</span> <span class="dv">3</span>)</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="co"># W^-1 and W</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>Wi <span class="ot">&lt;-</span> <span class="fu">P</span>(p0) <span class="sc">%*%</span> <span class="fu">R</span>(r0)</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>W <span class="ot">&lt;-</span> <span class="fu">t</span>(Wi)</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>W</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          [,1]       [,2]       [,3]
[1,] 0.9659099  0.0000000 -0.2588785
[2,] 0.1293906  0.8661339  0.4827734
[3,] 0.2242234 -0.4998120  0.8366073</code></pre>
</div>
</div>
<p>Because <span class="math inline">\(\Psi^t=\Psi^aW\)</span>, <span class="math inline">\(A_t = A_aW\)</span>, so rotation the animal’s acceleration vector by <span class="math inline">\(W\)</span> should give us the original <span class="math inline">\(A_t\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Animal is only experiencing gravity in the Z axis</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>Aa <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="fl">9.8</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Rotating At by W should give us Aa</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>Aa2 <span class="ot">&lt;-</span> At <span class="sc">%*%</span> W</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="fu">rbind</span>(<span class="at">Aa =</span> <span class="fu">round</span>(<span class="fu">as.vector</span>(Aa), <span class="dv">2</span>), </span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">Aa2 =</span> <span class="fu">round</span>(<span class="fu">as.vector</span>(Aa2), <span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    [,1] [,2] [,3]
Aa     0    0  9.8
Aa2    0    0  9.8</code></pre>
</div>
</div>
<p>Beautiful!</p>


</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>The Earth’s gravitational field isn’t <em>exactly</em> uniform, but it’s close enough for our purposes.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>Linear algebra is frickin’ weird, I know, I’m so sorry<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>